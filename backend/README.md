# yaarxiv backend

![Backend Build and Deploy Status](https://img.shields.io/github/workflow/status/ddadaal/yaarxiv/Build%20and%20Publish%20backend?label=Backend%20Build%20and%20Deploy&style=flat-square)
![Backend Coveralls](https://img.shields.io/coveralls/github/ddadaal/yaarxiv?label=Backend%20Test%20Coverage&style=flat-square)

# Features

- Auto parse the `schemas.json` (located at and generated by the api project) for model validation, faster serialization and deserialization, route specification, swagger generation.
- [nanoid](https://github.com/ai/nanoid) for user id generation
- [bcrypt](https://github.com/dcodeIO/bcrypt.js) to protect passwords

# Tools Used

- fastify
- typeorm
- TypeScript
- eslint

# Development

```bash
# Run command under . context, not under the whole project's root

# Start a local MySQL for dev and local test
# Username: root, Password: dbfordev
# The db files are stored under ./db which is gitignored.
docker-compose -f docker-compose.dev.yml up

# Install dependencies
npm install

# Run migrations
npm run typeorm:cli migration:run

# Start
npm start

# When executing typeorm:cli, pass argument using -- as follows
npm run typeorm:cli migration:generate -- -n now

```

# Configuration

[node-config](https://github.com/lorenwest/node-config) is used for configuration. Create config files on `config` dir according to its strategy.

For example, you will need a `production.json` (which can be copied from `production.sample.json`) for production deployment.

# Deployment

## Build

We use `webpack` to bundle the backend for simpler build and deployment and freedom from building API project separately.

```bash
# Clone the project (with the api project on the parent)

# Install dependencies
npm install

# Build
npm run build

```

## Built Assets

`dist` contains the following files which should be deployed to the production env.

```
.
├── config
│   ├── default.json
│   ├── production.json
├── migrations
├── ormconfig.js
├── out
│   └── bundle.js
├── package.json
├── package-lock.json
└── tsconfig.json
```

`scripts/copyAssets.ts` will copy the files above to the `dist` folder when building. The configuration files in `config`

## Serve

On the folder with built assets shown above,

```bash
# Only install production dependencies
npm ci --only=production

# Copy `config/production.sample.json` to `config/production.json` and change the configs
# Or use symlink or docker mount to mount a predefined production.json to the config directory
cp config/production.sample.json config/production.json
vim config/production.json

# Run!
npm run serve

```
